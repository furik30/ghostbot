# GhostBot

Telegram бот на основе Pyrogram с использованием Google Gemini AI для генерации ответов, исправления текста, анализа разговоров и подражания стилю.

## Репозиторий

Клонируйте проект: [https://github.com/furik30/ghostbot](https://github.com/furik30/ghostbot)

## Функции

- **Генерация ответов** (`.r`): Создание ответов в 3 стилях (краткий, нормальный, детальный) на основе истории чата, включая мультимедиа.
- **Исправление текста** (`.fix`): Коррекция грамматики, стиля и пунктуации.
- **Построение промптов** (`.p` / `:prompt`): Создание оптимизированных системных промптов для LLM.
- **Анализ разговора** (`.explain`): Психологический анализ истории, эмоций и советов по ответам.
- **Подражание стилю** (`.mimi`): Создание заметок о собеседнике для улучшения коммуникации.
- **Управление контекстом** (`.memo` / `.memoshow`): Сохранение и просмотр заметок по чату.

## Развертывание

### Docker (рекомендуется)

1. **Подготовка**: Скопируйте `.env.example` в `.env` и заполните API ключи.
2. **Сборка и запуск**:
   ```bash
   docker-compose up --build -d
   ```
3. **Просмотр логов**:
   ```bash
   docker-compose logs -f
   ```
4. **Остановка**:
   ```bash
   docker-compose down
   ```

### Локальная установка

1. **Клонирование и зависимости**:
   ```bash
   git clone https://github.com/furik30/ghostbot.git
   cd ghostbot
   pip install -r requirements.txt
   ```

2. **Настройка**:
   - Скопируйте `.env.example` в `.env`
   - Заполните переменные окружения

3. **Запуск**:
   ```bash
   python main.py
   ```

## Структура проекта

```
ghostbot/
├── .env                    # Переменные окружения
├── .env.example            # Пример переменных окружения
├── config.py               # Загрузка конфигураций и путей
├── main.py                 # Точка входа бота
├── requirements.txt        # Зависимости Python
├── prompts.yaml            # Системные промпты для AI
├── docker-compose.yml      # Docker Compose конфигурация
├── Dockerfile              # Docker образ
├── ghostbot.sh             # Скрипт управления ботом
├── install.sh              # Скрипт установки
├── database/               # База данных (создается автоматически)
│   ├── chat_contexts.json  # Заметки по чатам (.memo)
│   └── mimicry.db          # База для подражания стилю (.mimi)
├── sessions/               # Сессии Telegram (создается автоматически)
│   └── ghost_session.session
├── logs/                   # Логи (создается автоматически)
│   └── ghost.log           # Файл логов
├── data/                   # Данные для Docker (монтируется)
├── modules/                # Модули функций бота
│   ├── __init__.py
│   ├── reply_generator.py  # Генерация ответов (.r) с учетом истории и стилей
│   ├── prompt_builder.py   # Построение промптов (.p/:prompt) для LLM
│   ├── text_fixer.py       # Исправление текста (.fix) грамматика/стиль
│   ├── explain.py          # Анализ разговора (.explain) психология/эмоции
│   ├── mimicry.py          # Подражание стилю (.mimi) анализ собеседника
│   └── memo.py             # Управление контекстом (.memo/.memoshow)
└── utils/                  # Утилиты
    ├── gemini_api.py       # Интеграция с Google Gemini AI
    ├── common.py           # Общие функции (история чата, медиа, draft)
    └── logger.py           # Логирование (консоль + ротация файлов)
```

## Настройка

### Переменные окружения (.env)

- `API_ID`: Telegram API ID (https://my.telegram.org/)
- `API_HASH`: Telegram API Hash (https://my.telegram.org/)
- `GEMINI_KEY`: Google Gemini API ключ (https://ai.google.dev/)

## Использование

### Команды бота

- `.r [число_сообщений] [стиль] [доп_инструкция]`: Генерация ответа (стили: 1-краткий, 2-нормальный, 3-детальный)
- `[текст] .fix [заметки к исправлению]`: Исправление текста
- `.p / :prompt [запрос]`: Построение промпта
- `.explain [число_сообщений]`: Анализ разговора (результат в Избранное)
- `.mimi`: Подражание стилю (создает .memo команду)
- `.memo [текст]`: Сохранение заметки по чату
- `.memoshow`: Просмотр текущей заметки

### Примеры

```
.r 5 3 Будь вежливым
.fix Привет как дела?
:prompt Создай промпт для код-ревью
.explain 10
.mimi
.memo Этот собеседник любит шутки
.memoshow
```

### Управление ботом (ghostbot.sh)

Скрипт `ghostbot.sh` предоставляет команды для управления Docker-контейнером:

- `ghostbot up` - Запустить бота в фоне
- `ghostbot down` - Остановить бота
- `ghostbot restart` - Перезапустить бота
- `ghostbot logs [n]` - Показать логи (последние n строк)
- `ghostbot update` - Git pull + пересборка + перезапуск
- `ghostbot build` - Пересобрать образ
- `ghostbot status` - Статус контейнера
- `ghostbot login` - Интерактивный режим для авторизации
- `ghostbot edit-env` - Редактировать .env
- `ghostbot edit-prompts` - Редактировать prompts.yaml
- `ghostbot help` - Справка

## Логирование

Логи пишутся в консоль и файл `logs/ghost.log` с ротацией (максимум 3 файла по 5MB). Уровень: INFO.

## Технологии

- Pyrogram: Telegram API
- Google Gemini AI: Генерация текста и мультимедиа
- Docker: Контейнеризация
- YAML: Конфигурация промптов
- JSON: Хранение контекстов